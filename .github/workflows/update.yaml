name: Auto Update Model Catalog + Deploy to HuggingFace

on:
  workflow_dispatch:
  schedule:
    - cron: "0 3 * * 1"

jobs:
  update-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Install Dependencies
        run: |
          pip install huggingface_hub faiss-cpu sentence-transformers numpy pandas

      - name: Auto Build Catalog
        run: python build/auto_catalog.py

      - name: Merge Catalogs
        run: python build/merge_catalogs.py

      - name: Build FAISS Index
        run: python build/build_index.py

      - name: Commit Updated Files
        run: |
          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Actions"
          git add model_db.json model_index.faiss model_metadata.json
          git commit -m "Auto update catalog" || echo "No changes"
          git push

      - name: Push to HuggingFace Space
        env:
          HF_TOKEN: ${{ secrets.MR_HF_TOKEN }}
          HF_SPACE_REPO: ${{ secrets.HF_SPACE_REPO }}
        run: |
          git clone https://HF:${HF_TOKEN}@huggingface.co/spaces/${HF_SPACE_REPO} hf_space_repo
          cp model_db.json hf_space_repo/
          cp model_index.faiss hf_space_repo/
          cp model_metadata.json hf_space_repo/
          cd hf_space_repo
          git add .
          git commit -m "Auto deploy updated catalog" || echo "No changes"
          git push

